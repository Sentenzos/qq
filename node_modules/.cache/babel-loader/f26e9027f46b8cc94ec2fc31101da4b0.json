{"ast":null,"code":"import _regeneratorRuntime from\"D:\\\\my-own-social-network\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _objectSpread from\"D:\\\\my-own-social-network\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/objectSpread2\";import{authAPI,profileAPI}from\"../../API/API\";import{stopSubmit}from\"redux-form\";import{initializator,setError}from\"./appReducer\";import{isInitialized}from\"./appReducer\";var SET_ME=\"authReducer/SET_ME\";var SET_CAPTCHA=\"authReducer/SET_CAPTCHA\";var SET_MY_AVATAR=\"authReducer/SET_MY_AVATAR\";var initialState={id:null,email:null,login:null,isAuth:false,captchaUrl:null,myAvatars:{}};export var authReducer=function authReducer(){var state=arguments.length>0&&arguments[0]!==undefined?arguments[0]:initialState;var action=arguments.length>1?arguments[1]:undefined;switch(action.type){case SET_ME:return _objectSpread({},state,{},action.userData);case SET_CAPTCHA:return _objectSpread({},state,{captchaUrl:action.captchaUrl});case SET_MY_AVATAR:return _objectSpread({},state,{myAvatars:_objectSpread({},action.avatars)});default:return state;}};export var setMe=function setMe(userData){return{type:SET_ME,userData:userData};};export var setCaptcha=function setCaptcha(captchaUrl){return{type:SET_CAPTCHA,captchaUrl:captchaUrl};};export var setMyAvatars=function setMyAvatars(avatars){return{type:SET_MY_AVATAR,avatars:avatars};};export var getMe=function getMe(){return function _callee(dispatch){var userData,_userData$data$data,id,email,_login;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return _regeneratorRuntime.awrap(authAPI.getMe());case 3:userData=_context.sent;if(userData.data.resultCode===0){_userData$data$data=userData.data.data,id=_userData$data$data.id,email=_userData$data$data.email,_login=_userData$data$data.login;dispatch(setMe({id:id,email:email,login:_login,isAuth:true}));}_context.next=11;break;case 7:_context.prev=7;_context.t0=_context[\"catch\"](0);dispatch(setError(true,_context.t0.message));throw _context.t0;case 11:case\"end\":return _context.stop();}}},null,null,[[0,7]]);};};export var login=function login(userData){return function _callee2(dispatch,getState){var response,message,action;return _regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return _regeneratorRuntime.awrap(authAPI.login(userData));case 3:response=_context2.sent;if(!(response.data.resultCode===0)){_context2.next=10;break;}_context2.next=7;return _regeneratorRuntime.awrap(dispatch(initializator()));case 7://убрать старую каптчу\nif(getState().auth.captchaUrl)dispatch(setCaptcha(null));_context2.next=14;break;case 10:if(response.data.resultCode===10){dispatch(getCaptcha());}message=response.data.messages.length>0?response.data.messages[0]:\"Some error\";action=stopSubmit(\"login\",{_error:message});dispatch(action);case 14:_context2.next=20;break;case 16:_context2.prev=16;_context2.t0=_context2[\"catch\"](0);dispatch(setError(true,_context2.t0.message));throw _context2.t0;case 20:case\"end\":return _context2.stop();}}},null,null,[[0,16]]);};};export var logout=function logout(){return function _callee3(dispatch){var response;return _regeneratorRuntime.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return _regeneratorRuntime.awrap(authAPI.logout());case 3:response=_context3.sent;if(response.data.resultCode===0){dispatch(setMe({id:null,email:null,login:null,isAuth:false}));dispatch(isInitialized(false));}else{dispatch(setError(true,\"При попытке выхода возникла ошибка.\"));}_context3.next=11;break;case 7:_context3.prev=7;_context3.t0=_context3[\"catch\"](0);dispatch(setError(true,_context3.t0.message));throw _context3.t0;case 11:case\"end\":return _context3.stop();}}},null,null,[[0,7]]);};};export var getCaptcha=function getCaptcha(){return function _callee4(dispatch){var response,captchaUrl;return _regeneratorRuntime.async(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;_context4.next=3;return _regeneratorRuntime.awrap(authAPI.getCaptcha());case 3:response=_context4.sent;captchaUrl=response.data.url;dispatch(setCaptcha(captchaUrl));_context4.next=12;break;case 8:_context4.prev=8;_context4.t0=_context4[\"catch\"](0);dispatch(setError(true,_context4.t0.message));throw _context4.t0;case 12:case\"end\":return _context4.stop();}}},null,null,[[0,8]]);};};//так как серверный API кривой, приходится делать дополнительный запрос за аватаром\nexport var getMyAvatar=function getMyAvatar(){return function _callee5(dispatch,getState){var myId,res,myAvatars;return _regeneratorRuntime.async(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.prev=0;myId=getState().auth.id;_context5.next=4;return _regeneratorRuntime.awrap(profileAPI.getUserData(myId));case 4:res=_context5.sent;myAvatars=res.data.photos;dispatch(setMyAvatars(myAvatars));_context5.next=13;break;case 9:_context5.prev=9;_context5.t0=_context5[\"catch\"](0);dispatch(setError(true,_context5.t0.message));throw _context5.t0;case 13:case\"end\":return _context5.stop();}}},null,null,[[0,9]]);};};","map":{"version":3,"sources":["D:/my-own-social-network/src/redux/reducers/authReducer.js"],"names":["authAPI","profileAPI","stopSubmit","initializator","setError","isInitialized","SET_ME","SET_CAPTCHA","SET_MY_AVATAR","initialState","id","email","login","isAuth","captchaUrl","myAvatars","authReducer","state","action","type","userData","avatars","setMe","setCaptcha","setMyAvatars","getMe","dispatch","data","resultCode","message","getState","response","auth","getCaptcha","messages","length","_error","logout","url","getMyAvatar","myId","getUserData","res","photos"],"mappings":"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","sourcesContent":["import {authAPI, profileAPI} from \"../../API/API\";\r\nimport {stopSubmit} from \"redux-form\";\r\nimport {initializator, setError} from \"./appReducer\";\r\nimport {isInitialized} from \"./appReducer\";\r\n\r\n\r\nconst SET_ME = \"authReducer/SET_ME\";\r\nconst SET_CAPTCHA = \"authReducer/SET_CAPTCHA\";\r\nconst SET_MY_AVATAR = \"authReducer/SET_MY_AVATAR\";\r\n\r\n\r\nconst initialState = {\r\n  id: null,\r\n  email: null,\r\n  login: null,\r\n  isAuth: false,\r\n  captchaUrl: null,\r\n  myAvatars: {}\r\n};\r\n\r\nexport const authReducer = (state = initialState, action) => {\r\n  switch (action.type) {\r\n    case SET_ME:\r\n      return {\r\n        ...state,\r\n        ...action.userData\r\n      };\r\n    case SET_CAPTCHA:\r\n      return {\r\n        ...state,\r\n        captchaUrl: action.captchaUrl\r\n      };\r\n    case SET_MY_AVATAR:\r\n      return {\r\n        ...state,\r\n        myAvatars: {...action.avatars}\r\n      };\r\n    default:\r\n      return state\r\n  }\r\n};\r\n\r\n\r\nexport const setMe = (userData) => ({type: SET_ME, userData});\r\nexport const setCaptcha = (captchaUrl) => ({type: SET_CAPTCHA, captchaUrl});\r\nexport const setMyAvatars = (avatars) => ({type: SET_MY_AVATAR, avatars});\r\n\r\n\r\nexport const getMe = () => async (dispatch) => {\r\n  try {\r\n    const userData = await authAPI.getMe();\r\n    if (userData.data.resultCode === 0) {\r\n      const {id, email, login} = userData.data.data;\r\n      dispatch(setMe({id, email, login, isAuth: true}));\r\n    }\r\n  } catch (e) {\r\n    dispatch(setError(true, e.message));\r\n    throw e\r\n  }\r\n};\r\n\r\nexport const login = (userData) => async (dispatch, getState) => {\r\n  try {\r\n    const response = await authAPI.login(userData);\r\n    if (response.data.resultCode === 0) {\r\n      await dispatch(initializator());\r\n      //убрать старую каптчу\r\n      if (getState().auth.captchaUrl) dispatch(setCaptcha(null));\r\n    } else {\r\n      if (response.data.resultCode === 10) {\r\n        dispatch(getCaptcha());\r\n      }\r\n      const message = response.data.messages.length > 0 ?\r\n        response.data.messages[0] : \"Some error\";\r\n\r\n      const action = stopSubmit(\"login\", {_error: message});\r\n      dispatch(action);\r\n    }\r\n  } catch (e) {\r\n    dispatch(setError(true, e.message));\r\n    throw e\r\n  }\r\n};\r\n\r\nexport const logout = () => async (dispatch) => {\r\n  try {\r\n    let response = await authAPI.logout();\r\n    if (response.data.resultCode === 0) {\r\n      dispatch(setMe({id: null, email: null, login: null, isAuth: false}));\r\n      dispatch(isInitialized(false));\r\n    } else {\r\n      dispatch(setError(true, \"При попытке выхода возникла ошибка.\"));\r\n    }\r\n  } catch (e) {\r\n    dispatch(setError(true, e.message));\r\n    throw e\r\n  }\r\n};\r\n\r\nexport const getCaptcha = () => async (dispatch) => {\r\n  try {\r\n    const response = await authAPI.getCaptcha();\r\n    const captchaUrl = response.data.url;\r\n    dispatch(setCaptcha(captchaUrl));\r\n  } catch (e) {\r\n    dispatch(setError(true, e.message));\r\n    throw e\r\n  }\r\n};\r\n\r\n//так как серверный API кривой, приходится делать дополнительный запрос за аватаром\r\nexport const getMyAvatar = () => async (dispatch, getState) => {\r\n  try {\r\n    const myId = getState().auth.id;\r\n    const res = await profileAPI.getUserData(myId);\r\n    const myAvatars = res.data.photos;\r\n    dispatch(setMyAvatars(myAvatars));\r\n  } catch (e) {\r\n    dispatch(setError(true, e.message));\r\n    throw e\r\n  }\r\n};"]},"metadata":{},"sourceType":"module"}